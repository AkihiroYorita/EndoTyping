<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Typing! Game</title>
    <link rel="stylesheet" type="text/css" href="mystyle.css">
</head>

<body>
    <h3>遠藤タイピング</h3>
    <p id="target"></p>

    <form name="js">
    <input type="text" name="txtbox" placeholder="入力して下さい">
    </form>

    <div class="info">
        <p>Remaing Time :<span id="time"></span></p>
        <p>True count : <span id="score"></span></p>
        <p>Miss count : <span id="miss"></span></p>
    </div>


    <script>
        (function() {
                'use strict';
                //単語リスト
                var words = [
                    'test',
                    'endo',
                    'tanaka',
                    'satou',
                    'apple',
                    'aaaaa'
                ]

                var currentWord ;
                var currentLocation ;
                var score ;
                var miss ;
                var time;
                //typingが始まっているフラグ
                var isStarted;
                //timeを止める用のフラグ
                var  timeId;

                var target = document.getElementById('target');
                var missLabel = document.getElementById('miss');
                var scoreLabel = document.getElementById('score');
                var timeLabel = document.getElementById('time');
                var txtbox = document.js.txtbox.value;

                function init(){
                    currentWord = 'click to start!';
                    currentLocation=0;
                    score = 0;
                    miss =0;
                    time = 25;

                    target.innerHTML = currentWord;
                    scoreLabel.innerHTML = score;
                    missLabel.innerHTML = miss
                    timeLabel.innerHTML = time;
                    isStarted = false;
                }
                //click to startが表示され、初期化設定を行う
                init();

                function updateTime(){
                    timeId=setTimeout(function(){
                        time--;
                        timeLabel.innerHTML = time;
                        if(time <=0){
                            var accuracy = (score + miss ) === 0 ? '0.00':((score/(score+miss))*100).toFixed(2);
                            alert('score:'+score+'miss'+miss+'タイピング成功率'+accuracy+'%');
                            cleraTimeout(timeId);
                            init();
                            return;
                        }
                        updateTime();
                    },1000);
                }

                window.addEventListener('click',function(){
                    if(!isStarted){
                        isStarted = true;
                        setTarget();
                        updateTime();
                    }
                });


                function setTarget(){
                    currentWord = words[Math.floor(Math.random()*words.length)];
                    target.innerHTML = currentWord;
                    currentLocation = 0;
                }

                window.addEventListener('keyup', function(e) {
                        if(!isStarted){
                            return;
                        }
                        if (String.fromCharCode(e.keyCode) === currentWord[currentLocation].toUpperCase()){
                            currentLocation++;
                            var placeholder = '';
                            for (var i=0; i<currentLocation; i++){
                                placeholder += '_';
                            }
                            target.innerHTML = placeholder+ currentWord.substring(currentLocation);
                            score++;
                            scoreLabel.innerHTML =score;

                            if(currentLocation === currentWord.length){
                                setTarget();
                                document.js.txtbox.value="";
                            }
                        }else{
                            miss++;
                            missLabel.innerHTML = miss;
                        }
                    });
                })();
    </script>
</body>
</html>
